<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Baldora - Videojuego educativo para aprender y practicar las tablas de multiplicar hasta 15x15">
    <title>Baldora - Arimética en línea</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="images/baldora_favicon.svg">


    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Nunito:wght@400;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- FileSaver.js -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- Boton de Audio Toggle (Global) -->
    <button type="button" id="btn-audio-toggle" class="audio-toggle-btn" onclick="AudioManager.toggleMute()"
        title="Silenciar">&#128266;</button>

    <!-- ===== VISTA DE CONFIGURACION (INICIO) ===== -->
    <section id="config-view" class="view active">
        <div class="config-container">
            <div class="logo-section">
                <img src="images/baldora_banner.svg" alt="Fast Math Game - Domina las tablas de multiplicar"
                    class="logo-banner">
            </div>

            <form id="config-form" class="config-form">
                <div class="form-group">
                    <label for="nickname">Tu Nickname</label>
                    <input type="text" id="nickname" name="nickname" placeholder="Ingresa tu nombre" required
                        maxlength="20">
                </div>

                <div class="form-group">
                    <label>Modo de Juego</label>
                    <div class="mode-selector mode-selector-3">
                        <input type="radio" id="mode-timer" name="game-mode" value="TIMER" checked>
                        <label for="mode-timer" class="mode-option">
                            <span class="mode-icon">&#9201;</span>
                            <span class="mode-name">Contrarreloj</span>
                            <span class="mode-desc">Tiempo límite</span>
                        </label>

                        <input type="radio" id="mode-free" name="game-mode" value="FREE">
                        <label for="mode-free" class="mode-option">
                            <span class="mode-icon">&#127919;</span>
                            <span class="mode-name">Práctica Libre</span>
                            <span class="mode-desc">Sin límite</span>
                        </label>

                        <input type="radio" id="mode-adaptive" name="game-mode" value="ADAPTIVE">
                        <label for="mode-adaptive" class="mode-option">
                            <span class="mode-icon">&#129504;</span>
                            <span class="mode-name">Adaptativo</span>
                            <span class="mode-desc">Entrena debilidades</span>
                        </label>
                    </div>
                </div>

                <div class="form-group timer-config" id="timer-config">
                    <label for="time-limit">Tiempo Límite (minutos)</label>
                    <div class="time-slider-container">
                        <input type="range" id="time-limit" name="time-limit" min="1" max="15" value="1">
                        <span class="time-display" id="time-display">1 min</span>
                    </div>
                </div>

                <div class="form-group" id="tables-config">
                    <div class="factors-selection-container">
                        <!-- Factor A (Filas) -->
                        <div class="factor-selector">
                            <div class="factor-header">
                                <label>Factor A (Filas)</label>
                                <button type="button" class="btn-select-all" id="btn-select-all-rows">Todas</button>
                            </div>
                            <div class="tables-selector" id="rows-selector">
                                <div class="tables-grid" id="rows-grid">
                                    <button type="button" class="table-btn active" data-table="1"
                                        data-type="row">1</button>
                                    <button type="button" class="table-btn" data-table="2" data-type="row">2</button>
                                    <button type="button" class="table-btn" data-table="3" data-type="row">3</button>
                                    <button type="button" class="table-btn" data-table="4" data-type="row">4</button>
                                    <button type="button" class="table-btn" data-table="5" data-type="row">5</button>
                                    <button type="button" class="table-btn" data-table="6" data-type="row">6</button>
                                    <button type="button" class="table-btn" data-table="7" data-type="row">7</button>
                                    <button type="button" class="table-btn" data-table="8" data-type="row">8</button>
                                    <button type="button" class="table-btn" data-table="9" data-type="row">9</button>
                                    <button type="button" class="table-btn" data-table="10" data-type="row">10</button>
                                    <button type="button" class="table-btn" data-table="11" data-type="row">11</button>
                                    <button type="button" class="table-btn" data-table="12" data-type="row">12</button>
                                    <button type="button" class="table-btn" data-table="13" data-type="row">13</button>
                                    <button type="button" class="table-btn" data-table="14" data-type="row">14</button>
                                    <button type="button" class="table-btn" data-table="15" data-type="row">15</button>
                                </div>
                            </div>
                        </div>

                        <!-- Factor B (Columnas) -->
                        <div class="factor-selector">
                            <div class="factor-header">
                                <label>Factor B (Columnas)</label>
                                <button type="button" class="btn-select-all" id="btn-select-all-cols">Todas</button>
                            </div>
                            <div class="tables-selector" id="cols-selector">
                                <div class="tables-grid" id="cols-grid">
                                    <button type="button" class="table-btn active" data-table="1"
                                        data-type="col">1</button>
                                    <button type="button" class="table-btn" data-table="2" data-type="col">2</button>
                                    <button type="button" class="table-btn" data-table="3" data-type="col">3</button>
                                    <button type="button" class="table-btn" data-table="4" data-type="col">4</button>
                                    <button type="button" class="table-btn" data-table="5" data-type="col">5</button>
                                    <button type="button" class="table-btn" data-table="6" data-type="col">6</button>
                                    <button type="button" class="table-btn" data-table="7" data-type="col">7</button>
                                    <button type="button" class="table-btn" data-table="8" data-type="col">8</button>
                                    <button type="button" class="table-btn" data-table="9" data-type="col">9</button>
                                    <button type="button" class="table-btn" data-table="10" data-type="col">10</button>
                                    <button type="button" class="table-btn" data-table="11" data-type="col">11</button>
                                    <button type="button" class="table-btn" data-table="12" data-type="col">12</button>
                                    <button type="button" class="table-btn" data-table="13" data-type="col">13</button>
                                    <button type="button" class="table-btn" data-table="14" data-type="col">14</button>
                                    <button type="button" class="table-btn" data-table="15" data-type="col">15</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info del modo adaptativo (oculto por defecto) -->
                <div class="form-group adaptive-info" id="adaptive-info" hidden>
                    <div class="adaptive-info-card">
                        <span class="adaptive-info-icon">&#128161;</span>
                        <div class="adaptive-info-text">
                            <strong>Modo Adaptativo</strong>
                            <p>Selecciona las tablas que deseas practicar. Completaras todas las operaciones de esas
                                tablas, y luego el sistema detectara tus debilidades y te entrenara hasta dominarlas.
                            </p>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-start">
                    <span>COMENZAR</span>
                    <span class="btn-arrow">&#8594;</span>
                </button>
            </form>
        </div>
        <div class="config-decoration"></div>
    </section>

    <!-- ===== VISTA DE JUEGO (GAMEPLAY) ===== -->
    <section id="game-view" class="view">
        <div class="game-container">
            <!-- Panel Izquierdo: Matriz -->
            <div class="matrix-panel">
                <div class="matrix-header">
                    <span class="matrix-title" id="matrix-title">Tabla de Multiplicar</span>
                    <span class="matrix-progress" id="matrix-progress">0 / 225</span>
                </div>
                <!-- Indicador de fase para modo adaptativo -->
                <div class="adaptive-phase-indicator" id="adaptive-phase" hidden>
                    <span class="phase-badge phase-diagnosis">&#128203; Fase Diagnostico</span>
                </div>
                <div class="matrix-grid" id="matrix-grid">
                    <!-- Grid generado por JS -->
                </div>
            </div>

            <!-- Panel Derecho: Controles -->
            <div class="controls-panel">
                <div class="timer-display" id="timer-display">
                    <span class="timer-label" id="timer-label">Tiempo</span>
                    <span class="timer-value" id="timer-value">05:00</span>
                </div>

                <div class="operation-display">
                    <div class="operation-card" id="operation-card">
                        <span class="factor" id="factor-a">?</span>
                        <span class="operator">x</span>
                        <span class="factor" id="factor-b">?</span>
                        <span class="equals">=</span>
                    </div>
                    <input type="number" id="answer-input" class="answer-input" placeholder="?" min="1" max="225"
                        autofocus>
                    <button type="button" class="btn-end" id="btn-end-session">
                        Terminar Sesion
                    </button>
                </div>

                <div class="stats-row">
                    <div class="stat-card stat-correct">
                        <span class="stat-icon">&#10003;</span>
                        <span class="stat-value" id="stat-correct">0</span>
                        <span class="stat-label">Aciertos</span>
                    </div>
                    <div class="stat-card stat-wrong">
                        <span class="stat-icon">&#10007;</span>
                        <span class="stat-value" id="stat-wrong">0</span>
                        <span class="stat-label">Errores</span>
                    </div>
                </div>

                <!-- Contador de debilidades restantes (modo adaptativo) -->
                <div class="weaknesses-counter" id="weaknesses-counter" hidden>
                    <span class="weaknesses-icon">&#127919;</span>
                    <span class="weaknesses-value" id="weaknesses-value">0</span>
                    <span class="weaknesses-label">Debilidades restantes</span>
                </div>
            </div>
        </div>
    </section>

    <!-- ===== VISTA DE ANALITICAS (DASHBOARD) ===== -->
    <section id="dashboard-view" class="view">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <h2 class="dashboard-title">&#128202; Analiticas de Sesion</h2>
                <div class="dashboard-actions">
                    <button type="button" class="btn-download" id="btn-download-csv">
                        &#128229; Descargar CSV
                    </button>
                    <button type="button" class="btn-secondary" id="btn-new-game">
                        Nueva Partida
                    </button>
                </div>
            </div>

            <div class="summary-cards">
                <div class="summary-card">
                    <span class="summary-icon">&#127919;</span>
                    <span class="summary-value" id="summary-total">0</span>
                    <span class="summary-label">Operaciones</span>
                </div>
                <div class="summary-card">
                    <span class="summary-icon">&#9989;</span>
                    <span class="summary-value" id="summary-correct">0</span>
                    <span class="summary-label">Correctas</span>
                </div>
                <div class="summary-card">
                    <span class="summary-icon">&#9889;</span>
                    <span class="summary-value" id="summary-avg-time">0ms</span>
                    <span class="summary-label">Tiempo Promedio</span>
                </div>
                <div class="summary-card">
                    <span class="summary-icon">&#128200;</span>
                    <span class="summary-value" id="summary-accuracy">0%</span>
                    <span class="summary-label">Precision</span>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">Distribucion de Rendimiento</h3>
                    <div class="chart-container">
                        <canvas id="chart-pie"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Errores por Tabla</h3>
                    <div class="chart-container">
                        <canvas id="chart-bar-tables"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Top 5 Operaciones Dificiles</h3>
                    <div class="chart-container">
                        <canvas id="chart-bar-top"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Velocidad de Respuesta</h3>
                    <div class="chart-container">
                        <canvas id="chart-histogram"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ===== MODAL DE INACTIVIDAD ===== -->
    <div id="inactivity-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon">&#9200;</div>
            <h2 class="modal-title">Sesion Pausada</h2>
            <p class="modal-message">El juego se reinicio por inactividad (30 segundos sin respuesta)</p>
            <button type="button" class="btn-modal" onclick="App.closeInactivityModal()">
                Volver al Inicio
            </button>
        </div>
    </div>

    <!-- ===== MODAL DE TRANSICION ADAPTATIVO ===== -->
    <div id="adaptive-transition-modal" class="modal-overlay">
        <div class="modal-content modal-adaptive">
            <div class="modal-icon">&#128269;</div>
            <h2 class="modal-title">Analisis Completado</h2>
            <p class="modal-message">Hemos detectado <strong id="weakness-count">0</strong> debilidades.</p>
            <p class="modal-submessage">Iniciando protocolo de correccion...</p>
            <button type="button" class="btn-modal" onclick="App.startTrainingPhase()">
                Comenzar Entrenamiento
            </button>
        </div>
    </div>

    <!-- ===== MODAL DE VICTORIA ADAPTATIVO ===== -->
    <div id="adaptive-victory-modal" class="modal-overlay">
        <div class="modal-content modal-victory">
            <div class="modal-icon">&#127942;</div>
            <h2 class="modal-title">Entrenamiento Completado!</h2>
            <p class="modal-message">Has dominado todas las operaciones problematicas.</p>
            <div class="victory-stats">
                <div class="victory-stat">
                    <span class="victory-stat-value" id="victory-initial">0</span>
                    <span class="victory-stat-label">Debilidades iniciales</span>
                </div>
                <div class="victory-stat">
                    <span class="victory-stat-value" id="victory-rounds">0</span>
                    <span class="victory-stat-label">Rondas completadas</span>
                </div>
                <div class="victory-stat">
                    <span class="victory-stat-value" id="victory-help-count">0</span>
                    <span class="victory-stat-label">Ayudas visuales</span>
                </div>
            </div>
            <button type="button" class="btn-modal" onclick="App.finishAdaptiveMode()">
                Ver Resultados
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/audioManager.js"></script>
    <script src="js/data.js"></script>
    <script src="js/grid.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/app.js"></script>
</body>

</html>